!function(e,t,r){"undefined"!=typeof module&&module.exports?module.exports=r():"function"==typeof define&&define.amd?define(r):t[e]=r()}("Treasure",this,function(){"use strict";function Treasure(){return _init.apply(this,arguments)}function _validate(e){if(_isUndefined(e))throw new Error("Check out our JavaScript SDK Usage Guide: http://docs.treasuredata.com/articles/javascript-sdk/");if(_isUndefined(e.database)||"String"!==_type(e.database)||!e.database.length)throw new Error("Please provide a database");if(!/^[a-z0-9_]{3,255}$/.test(e.database))throw new Error("Database must be between 3 and 255 characters and must consist only of lower case letters, numbers, and _")}function _init(e){_validate(e),this.configure(e)}function _extend(e){for(var t=1;t<arguments.length;t++)for(var r in arguments[t])e[r]=arguments[t][r];return e}function _isUndefined(e){return void 0===e}function _type(e){var t=e&&e.constructor?e.constructor.toString():void 0;return t?t.match(/function (.*)\(/)[1]:"Null"}function _each(e,t,r){var n;if(!e)return 0;if(r=r?r:e,"array"===_type(e)){for(n=0;n<e.length;n++)if(t.call(r,e[n],n,e)===!1)return 0}else for(n in e)if(e.hasOwnProperty(n)&&t.call(r,e[n],n,e)===!1)return 0;return 1}function _set_protocol(e){switch(e=e||"auto"){case"http":return"http";case"https":return"https";default:return location.protocol.replace(/:/g,"")}}function _set_request_type(e){return e=e||"auto","auto"!==e?e:("Object"===_type(XMLHttpRequest)||"Function"===_type(XMLHttpRequest))&&"withCredentials"in new XMLHttpRequest?"xhr":"jsonp"}function _build_url(e){return this.client.endpoint+"/js/v3/event/"+this.client.database+e}function _uploadEvent(e,t,r,n){if(_isUndefined(e)||"String"!==_type(e)||!e.length)throw new Error("Please provide a table");if(!/^[a-z0-9_]{3,255}$/.test(e))throw new Error("Table must be between 3 and 255 characters and must consist only of lower case letters, numbers, and _");if(_isUndefined(t)||"Object"!==_type(t)||!t)throw new Error("Please provide an event");var o,a,i=_build_url.apply(this,["/"+e]),s={};this.client.globalProperties&&(s=this.client.globalProperties(e),"Object"===_type(s)&&s||(Treasure.log("Your globalProperties function did not return an object, defaulting to empty object"),s={}));for(var u in t)t.hasOwnProperty(u)&&(s[u]=t[u]);switch(this.client.requestType){case"xhr":_request.xhr.apply(this,["POST",i,null,s,this.client.writeKey,r,n]);break;case"jsonp":o=JSON.stringify(s),a=Treasure.Base64.encode(o),i=i+"?api_key="+encodeURIComponent(this.client.writeKey),i=i+"&data="+encodeURIComponent(a),i=i+"&modified="+encodeURIComponent((new Date).getTime()),_request.jsonp.apply(this,[i,this.client.writeKey,r,n])}}Treasure.prototype.configure=function(e){return _validate(e),e.host=_isUndefined(e.host)?"in.treasuredata.com":e.host.replace(/.*?:\/\//g,""),e.protocol=_set_protocol(e.protocol),e.requestType=_set_request_type(e.requestType),this.client={database:e.database,writeKey:e.writeKey,globalProperties:null,endpoint:e.protocol+"://"+e.host,requestType:e.requestType},Treasure.trigger("client",this,e),this.trigger("ready"),this};var _request={xhr:function(e,t,r,n,o,a,i){if(!o)return Treasure.log("Please provide an apikey from https://console.treasuredata.com/users/current");var s=new XMLHttpRequest;if(s.onreadystatechange=function(){if(4===s.readyState)if(s.status>=200&&s.status<300){var e;try{e=JSON.parse(s.responseText)}catch(t){Treasure.log("Could not JSON parse HTTP response: "+s.responseText),i&&i(s,t)}a&&e&&a(e)}else Treasure.log("HTTP request failed."),i&&i(s,null)},s.open(e,t,!0),o&&s.setRequestHeader("X-TD-WRITE-KEY",o),n&&s.setRequestHeader("Content-Type","application/json"),r)for(var u in r)r.hasOwnProperty(u)&&s.setRequestHeader(u,r[u]);var c=n?JSON.stringify(n):null;s.send(c)},jsonp:function(e,t,r,n){if(!t)return Treasure.log("Please provide an apikey from https://console.treasuredata.com/users/current");if(t&&e.indexOf("api_key")<0){var o=e.indexOf("?")>0?"&":"?";e=e+o+"api_key="+t}for(var a="TreasureJSONPCallback"+(new Date).getTime();a in window;)a+="a";var i=!1;window[a]=function(e){i=!0,r&&e&&r(e),window[a]=void 0},e=e+"&callback="+a;var s=document.createElement("script");s.id="td-jsonp",s.src=e,document.getElementsByTagName("head")[0].appendChild(s),s.onreadystatechange=function(){i===!1&&"loaded"===this.readyState&&(i=!0,n&&n())},s.onerror=function(){i===!1&&(i=!0,n&&n())}}},Events=Treasure.Events={on:function(e,t){this.listeners=this.listeners||{};var r=this.listeners[e]||(this.listeners[e]=[]);return r.push({callback:t}),this},off:function(e,t){if(!e&&!t)return this.listeners=void 0,delete this.listeners,this;for(var r=this.listeners[e]||[],n=r.length;n--;)t&&t===r[n].callback&&this.listeners[e].splice(n,1),t&&0!==r.length||(this.listeners[e]=void 0,delete this.listeners[e]);return this},trigger:function(e){if(!this.listeners)return this;for(var t=Array.prototype.slice.call(arguments,1),r=this.listeners[e]||[],n=0;n<r.length;n++)r[n].callback.apply(this,t);return this}};_extend(Treasure.prototype,Events),_extend(Treasure,Events),Treasure.loaded=!0,Treasure.utils={each:_each,extend:_extend},Treasure.ready=function(e){Treasure.loaded?e():Treasure.on("ready",e)},Treasure.log=function(e){"object"==typeof console&&console.log("[Treasure]",e)},Treasure.prototype.addEvent=function(){_uploadEvent.apply(this,arguments)},Treasure.prototype.setGlobalProperties=function(e){if(!this.client)return Treasure.log("Check out our JavaScript SDK Usage Guide: http://docs.treasuredata.com/articles/javascript-sdk");if(!e||"function"!=typeof e)throw new Error("Invalid value for global properties: "+e);this.client.globalProperties=e},Treasure.Base64={map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t,r,n,o,a,i,s,u="",c=0,l=this.map;for(e=this.utf8.encode(e);c<e.length;)t=e.charCodeAt(c++),r=e.charCodeAt(c++),n=e.charCodeAt(c++),o=t>>2,a=(3&t)<<4|r>>4,i=isNaN(r)?64:(15&r)<<2|n>>6,s=isNaN(r)||isNaN(n)?64:63&n,u=u+l.charAt(o)+l.charAt(a)+l.charAt(i)+l.charAt(s);return u},decode:function(e){var t,r,n,o,a,i,s,u="",c=0,l=this.map,f=String.fromCharCode;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");c<e.length;)t=l.indexOf(e.charAt(c++)),r=l.indexOf(e.charAt(c++)),n=l.indexOf(e.charAt(c++)),o=l.indexOf(e.charAt(c++)),a=t<<2|r>>4,i=(15&r)<<4|n>>2,s=(3&n)<<6|o,u=u+(f(a)+(64!=n?f(i):""))+(64!=o?f(s):"");return this.utf8.decode(u)},utf8:{encode:function(e){for(var t,r="",n=0,o=String.fromCharCode;n<e.length;)t=e.charCodeAt(n++),r+=128>t?o(t):t>127&&2048>t?o(t>>6|192)+o(63&t|128):o(t>>12|224)+o(t>>6&63|128)+o(63&t|128);return r},decode:function(e){for(var t,r,n="",o=0,a=String.fromCharCode;o<e.length;)r=e.charCodeAt(o),n+=128>r?[a(r),o++][0]:r>191&&224>r?[a((31&r)<<6|63&(t=e.charCodeAt(o+1))),o+=2][0]:[a((15&r)<<12|(63&(t=e.charCodeAt(o+1)))<<6|63&(c3=e.charCodeAt(o+2))),o+=3][0];return n}}},"object"!=typeof JSON&&(JSON={}),function(){function f(e){return 10>e?"0"+e:e}function quote(e){return escapable.lastIndex=0,escapable.test(e)?'"'+e.replace(escapable,function(e){var t=meta[e];return"string"==typeof t?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+e+'"'}function str(e,t){var r,n,o,a,i,s=gap,u=t[e];switch(u&&"object"==typeof u&&"function"==typeof u.toJSON&&(u=u.toJSON(e)),"function"==typeof rep&&(u=rep.call(t,e,u)),typeof u){case"string":return quote(u);case"number":return isFinite(u)?String(u):"null";case"boolean":case"null":return String(u);case"object":if(!u)return"null";if(gap+=indent,i=[],"[object Array]"===Object.prototype.toString.apply(u)){for(a=u.length,r=0;a>r;r+=1)i[r]=str(r,u)||"null";return o=0===i.length?"[]":gap?"[\n"+gap+i.join(",\n"+gap)+"\n"+s+"]":"["+i.join(",")+"]",gap=s,o}if(rep&&"object"==typeof rep)for(a=rep.length,r=0;a>r;r+=1)"string"==typeof rep[r]&&(n=rep[r],o=str(n,u),o&&i.push(quote(n)+(gap?": ":":")+o));else for(n in u)Object.prototype.hasOwnProperty.call(u,n)&&(o=str(n,u),o&&i.push(quote(n)+(gap?": ":":")+o));return o=0===i.length?"{}":gap?"{\n"+gap+i.join(",\n"+gap)+"\n"+s+"}":"{"+i.join(",")+"}",gap=s,o}}"function"!=typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;"function"!=typeof JSON.stringify&&(JSON.stringify=function(e,t,r){var n;if(gap="",indent="","number"==typeof r)for(n=0;r>n;n+=1)indent+=" ";else"string"==typeof r&&(indent=r);if(rep=t,t&&"function"!=typeof t&&("object"!=typeof t||"number"!=typeof t.length))throw new Error("JSON.stringify");return str("",{"":e})}),"function"!=typeof JSON.parse&&(JSON.parse=function(text,reviver){function walk(e,t){var r,n,o=e[t];if(o&&"object"==typeof o)for(r in o)Object.prototype.hasOwnProperty.call(o,r)&&(n=walk(o,r),void 0!==n?o[r]=n:delete o[r]);return reviver.call(e,t,o)}var j;if(text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}(),!function(e,t,r){"undefined"!=typeof module&&module.exports?module.exports=r():"function"==typeof define&&define.amd?define(r):t[e]=r()}("domready",Treasure.utils,function(e){function t(e){for(p=1;e=n.shift();)e()}var r,n=[],o=!1,a=document,i=a.documentElement,s=i.doScroll,u="DOMContentLoaded",c="addEventListener",l="onreadystatechange",f="readyState",d=s?/^loaded|^c/:/^loaded|c/,p=d.test(a[f]);return a[c]&&a[c](u,r=function(){a.removeEventListener(u,r,o),t()},o),s&&a.attachEvent(l,r=function(){/^c/.test(a[f])&&(a.detachEvent(l,r),t())}),e=s?function(t){self!=top?p?t():n.push(t):function(){try{i.doScroll("left")}catch(r){return setTimeout(function(){e(t)},50)}t()}()}:function(e){p?e():n.push(e)}});var loaded=window.Treasure,cached=window._Treasure||{},clients,ready;if(loaded&&cached){clients=cached.clients||{},ready=cached.ready||[];for(var instance in clients)if(clients.hasOwnProperty(instance)){var client=clients[instance];for(var method in Treasure.prototype)Treasure.prototype.hasOwnProperty(method)&&(loaded.prototype[method]=Treasure.prototype[method]);if(client._config&&(client.configure.call(client,client._config),delete client._config),client._setGlobalProperties){for(var globals=client._setGlobalProperties,i=0;i<globals.length;i++)client.setGlobalProperties.apply(client,globals[i]);delete client._setGlobalProperties}if(client._addEvent){for(var queue=client._addEvent||[],i=0;i<queue.length;i++)client.addEvent.apply(client,queue[i]);delete client._addEvent}var callback=client._on||[];if(client._on){for(var i=0;i<callback.length;i++)client.on.apply(client,callback[i]);client.trigger("ready"),delete client._on}}for(var callbackGenerator=function(e){return function(){e()}},i=0;i<ready.length;i++){var callback=ready[i];Treasure.on("ready",callbackGenerator(callback))}}return Treasure.loaded&&setTimeout(function(){Treasure.utils.domready(function(){Treasure.trigger("ready")})},0),Treasure});